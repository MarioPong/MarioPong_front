<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>디버그용 멀티플레이 로비</title>
  <style>
    body { font-family: sans-serif; background: #ececec; margin: 0; }
    #container { max-width: 500px; margin: 40px auto; background: #fff; padding: 30px; box-shadow: 0 2px 8px #bbb; }
    h1 { font-size: 1.5em; color: #3b4cca; }
    .section { margin-bottom: 20px; }
    #logs { height: 120px; overflow-y: auto; border: 1px solid #bbb; background: #0a0; color: #fff; padding: 7px; font-size: 0.93em; margin-bottom: 10px; }
    input[type=text] { padding: 6px; width: 60%; margin-right: 7px; }
    button { padding: 6px 12px; background: #3b4cca; color: #fff; border: none; border-radius: 4px; }
    button:disabled { opacity: 0.6; }
    #players { border: 1px solid #bbb; padding: 5px; min-height: 32px; background: #fafaf8; margin-bottom: 12px; }
    .status { font-size: 1em; margin-bottom: 10px; }
    .ready { color: #09c909; }
    .not-ready { color: #f45959; }
  </style>
  <!-- socket.io client 라이브러리 필요: 서버와 버전에 맞게 소스를 불러오세요 -->
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div id="container">
    <h1>디버깅용 멀티 로비</h1>

    <div class="section">
      <div>연결 상태: <span id="connState" class="status not-ready">연결 대기중...</span></div>
      <div id="logs"></div>
    </div>

    <div class="section">
      <div>
        <input type="text" id="roomInput" placeholder="방 이름(입력/생성)">
        <button id="joinBtn">접속/생성</button>
        <button id="leaveBtn" disabled>퇴장</button>
      </div>
    </div>

    <div class="section">
      <div>현재 방: <span id="roomName">-</span></div>
      <div>플레이어 목록:</div>
      <div id="players">없음</div>
    </div>
    <div class="section">
      <button id="readyBtn" disabled>READY</button>
    </div>
  </div>

  <script>
    // 클라이언트 로직
    const socket = io();
    const logs = document.getElementById('logs');
    function log(txt) {
      logs.innerHTML += txt + '<br>';
      logs.scrollTop = logs.scrollHeight;
      console.log('[SOCKET-LOG]', txt);
    }

    // 디버깅용 전역 socket 이벤트 로깅
    const eventsToLog = [
      'connect', 'disconnect', 'reconnect', 'connect_error',
      'room_joined', 'room_left', 'player_update', 'ready_state',
      // 서버에서 사용하는 추가 이벤트명도 여기에 등록 추천
    ];
    for (const evt of eventsToLog) {
      socket.on(evt, (...args) => {
        log(`수신: ${evt} | 데이터: ${JSON.stringify(args)}`);
      });
    }

    // 상태 UI 핸들러
    socket.on('connect', () => {
      document.getElementById('connState').textContent = '연결됨';
      document.getElementById('connState').className = 'status ready';
      document.getElementById('joinBtn').disabled = false;
      log('Socket 연결 성공');
    });
    socket.on('disconnect', () => {
      document.getElementById('connState').textContent = '연결 해제됨';
      document.getElementById('connState').className = 'status not-ready';
      log('Socket 연결 해제');
      document.getElementById('joinBtn').disabled = false;
      document.getElementById('leaveBtn').disabled = true;
      document.getElementById('readyBtn').disabled = true;
      updateRoomInfo(null, []);
    });

    // 방 입장/퇴장 처리
    document.getElementById('joinBtn').onclick = () => {
      const room = document.getElementById('roomInput').value.trim();
      if (room) {
        socket.emit('join_room', { room });
        log('요청: join_room - ' + room);
      }
    };
    document.getElementById('leaveBtn').onclick = () => {
      socket.emit('leave_room');
      log('요청: leave_room');
    };

    // 준비 상태 토글
    document.getElementById('readyBtn').onclick = () => {
      socket.emit('toggle_ready');
      log('요청: toggle_ready');
    };

    // 방에 입장하면 서버에서 room_joined 이벤트와 함께 방, 플레이어 정보를 주는 구조 예시
    socket.on('room_joined', ({ room, players }) => {
      updateRoomInfo(room, players);
      document.getElementById('leaveBtn').disabled = false;
      document.getElementById('readyBtn').disabled = false;
      document.getElementById('joinBtn').disabled = true;
      log('방에 입장: ' + room);
    });
    socket.on('room_left', () => {
      updateRoomInfo(null, []);
      document.getElementById('leaveBtn').disabled = true;
      document.getElementById('readyBtn').disabled = true;
      document.getElementById('joinBtn').disabled = false;
      log('방 나가기 완료');
    });

    // 플레이어 목록 갱신
    socket.on('player_update', ({ players }) => {
      updatePlayers(players);
    });

    // ready 상태 안내 (예시용)
    socket.on('ready_state', ({ ready }) => {
      log('[플레이어 준비상태 업데이트]: ' + ready);
    });

    function updateRoomInfo(room, players) {
      document.getElementById('roomName').textContent = room || '-';
      updatePlayers(players || []);
    }
    function updatePlayers(players) {
      // players: [{nickname, ready}, ...]
      if (!players || !players.length) {
        document.getElementById('players').textContent = '없음';
        return;
      }
      document.getElementById('players').innerHTML = players.map(
        p => `${p.nickname} <span style="color:${
          p.ready ? '#09c909' : '#f45959'
        };font-weight:bold;">[${p.ready ? 'READY' : 'NOT READY'}]</span>`
      ).join('<br>');
    }

    // 유용한 추가 디버깅 요소 (네트워크 딜레이 테스트 등)
    // 소켓 지연 시뮬레이션 버튼 만드는 것도 가능

    // (선택 사항) LocalStorage.debug 등 Socket.IO 디버깅 문법 활용
    try {
      localStorage.debug = '*';
      log('localStorage.debug = "*"으로 세팅');
    } catch(e) {}

  </script>
</body>
</html>
